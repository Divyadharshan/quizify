<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="Quizify">
    <meta property="og:description"
        content="Take Daily Quiz, AI-powered or user-created quizzes, climb the leaderboards, and enjoy fair play">
    <meta property="og:image" content="https://res.cloudinary.com/di5q8uqqc/image/upload/v1743228609/logo_n6jite.png">
    <meta property="og:url" content="https://quizify.azurewebsites.net/">
    <title>Quizify - REGISTER</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="shortcut icon" href="/logo.png" type="image/x-icon">
</head>

<body>
    <%- include("../partials/loader") %>
    <%- include("../partials/flash") %>

    <div class="login-container">
        <h1>QUIZIFY</h1>
        <div style="display: flex; justify-content: center; align-items: center;">
            <a href="/auth/google" style="text-decoration: none;">
                <button style="display: flex;">
                    <img src="https://sm.pcmag.com/pcmag_me/review/g/google-doc/google-docs-sheets-and-slides_f6we.png"
                        alt="Google Logo" style="width: 20px; height: 20px; margin-right: 10px;">
                    Sign Up with Google
                </button>
            </a>
        </div>
        <br>
        or
        <form action="/register" method="POST" class="validated-form" novalidate>
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required>

            <label for="email">Email</label>
            <input type="email" id="email" name="email" required><br><br>
            <div class="invalid-feedback" style="color: red; font-size: 18px; display: none;">
            </div>
            <button type="submit" style="width: 60%;">VERIFY & REGISTER</button>
            <p>Already have an account? <a href="/login" style="color:#7B16FF; text-decoration:none;">Login</a></p>
        </form>
    </div>

    <script>
        (function () {
            'use strict';
            function debounce(func,delay){
                let timer;
                return function(...args){
                    clearTimeout(timer);
                    timer = setTimeout(()=>func.apply(this,args),delay);
                };
            }

            const forms = document.querySelectorAll('.validated-form');

            Array.from(forms).forEach(function (form) {
                    const usernameInput = form.querySelector('input[name="username"]');
                    const emailInput = form.querySelector('input[name="email"]');
                    const feedback = form.querySelector('.invalid-feedback');
                    const usernamePattern = /^[a-z0-9_]+$/;

                    usernameInput.addEventListener("input",debounce(async function(){
                        if(!usernamePattern.test(usernameInput.value)){
                            usernameInput.setCustomValidity("Invalid");
                            feedback.style.display="block";
                            feedback.textContent="Allowed : a-z, 0-9, _ only"
                        }
                        else if ((usernameInput.value.length<4)){
                            usernameInput.setCustomValidity("Invalid");
                            feedback.style.display="block";
                            feedback.textContent="Username must be at least 4 characters long"
                        }
                        else{
                            usernameInput.setCustomValidity("");
                            feedback.style.display="none";
                            if(usernameInput.value.length>=4){
                                const response=await fetch(`/checkusername?username=${usernameInput.value}`);
                                const data=await response.json();
                                if(data.exists){
                                    feedback.textContent="Username already taken";
                                    feedback.style.display="block";
                                    usernameInput.setCustomValidity("Taken")
                                }
                            }
                        }
                    },500));
                    emailInput.addEventListener('input', debounce(async function () {
                    emailInput.setCustomValidity('');
                    if (emailInput.value.length > 5) {
                       const response=await fetch(`/checkemail?email=${emailInput.value}`);
                       const data=await response.json();
                       if (data.exists) {
                           feedback.textContent="Email already registered";
                           feedback.style.display="block";
                           emailInput.setCustomValidity("Taken");
                       } 
                       else {
                            feedback.style.display = "none";
                       }
                     }
                    }, 500));
                form.addEventListener('submit', function (event) {
                    if(!form.checkValidity()){
                        event.preventDefault();
                        event.stopPropagation();
                        feedback.textContent = "The entered Username/Email is invalid or already in use";
                        feedback.style.display = "block";
                    }
                }, false);
            });
        })();
    </script>
</body>

</html>
